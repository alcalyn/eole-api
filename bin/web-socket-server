<?php

echo 'Initialization...'.PHP_EOL;

require_once __DIR__.'/../vendor/autoload.php';

use React\ZMQ\Context;
use React\Socket\Server;
use Ratchet\Server\IoServer;
use Ratchet\Http\HttpServer;
use Ratchet\WebSocket\WsServer;
use Ratchet\Wamp\ServerProtocol;
use Eole\Silex\Application as SilexApplication;
use Eole\WebSocket\Application as WebSocketApplication;

// Create Eole silex application
$silexApp = new SilexApplication(array(
    'project.root' => dirname(__DIR__),
    'env' => 'dev',
    'debug' => true,
));

$loop = React\EventLoop\Factory::create();

// Create push server
$pushHost = $silexApp['environment']['push_server']['server']['host'];
$pushPort = $silexApp['environment']['push_server']['server']['port'];

$context = new Context($loop);
$pushServer = $context->getSocket(ZMQ::SOCKET_PULL);
$pushServer->bind("tcp://$pushHost:$pushPort");
$pushServer->on('message', function ($message) {
    echo 'PushServer message: '.$message.PHP_EOL;
});

// Create Eole websocket application
$wsApp = new WebSocketApplication($silexApp);

$socketHost = $silexApp['environment']['websocket']['server']['host'];
$socketPort = $silexApp['environment']['websocket']['server']['port'];

$socket = new Server($loop);
$socket->listen($socketPort, $socketHost);

$server = new IoServer(
    new HttpServer(
        new WsServer(
            new ServerProtocol($wsApp)
        )
    ),
    $socket
);

// Run servers
echo "Running websocket server on $socketHost:$socketPort".PHP_EOL;
echo "Running push server on $pushHost:$pushPort".PHP_EOL;

$loop->run();
