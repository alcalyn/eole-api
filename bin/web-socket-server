<?php

require_once __DIR__.'/../vendor/autoload.php';

use Ratchet\Server\IoServer;
use Ratchet\Http\HttpServer;
use Ratchet\WebSocket\WsServer;
use Ratchet\Wamp\ServerProtocol;
use Eole\Silex\Application as SilexApplication;
use Eole\WebSocket\Application as WebSocketApplication;

echo 'Initialization...'.PHP_EOL;

// Create Eole silex application
$silexApp = new SilexApplication(array(
    'project.root' => dirname(__DIR__),
    'env' => 'dev',
    'debug' => true,
));

$silexApp['eole.websocket_topic.chat'] = function () {
    return new Eole\WebSocket\ApplicationTopic\Chat('eole/core/chat');
};

$silexApp['eole.websocket_topic.game_parties'] = function () {
    return new Eole\WebSocket\ApplicationTopic\GameParties('eole/core/parties');
};

$silexApp->tagService('websocket.topic', 'eole.websocket_topic.chat');
$silexApp->tagService('websocket.topic', 'eole.websocket_topic.game_parties');

// Create Eole websocket application
$wsApp = new WebSocketApplication($silexApp);

$address = '0.0.0.0';
$port = 8080;

// Create websocket server
$server = IoServer::factory(new HttpServer(new WsServer(new ServerProtocol($wsApp))), $port, $address);

echo 'Running websocket server...'.PHP_EOL;

$server->run();
